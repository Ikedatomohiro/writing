# Task Start Rules

## タスク開始前の必須確認

**リポジトリ内のファイルを変更する際は、必ず以下の手順を実行すること。**

### 適用範囲

以下のすべての作業が対象:
- 新機能の実装
- バグ修正
- 既存PRへのレビュー対応・修正
- リファクタリング
- ドキュメント修正
- 設定ファイルの変更

### 禁止事項

以下の操作は禁止:
- `gh pr checkout <PR番号>` でブランチに直接チェックアウト
- `git checkout <ブランチ名>` で作業ブランチに直接チェックアウト
- mainブランチで直接ファイルを編集

### 1. mainブランチを最新にする

worktree作成前に、必ずmainブランチを最新の状態にする。

```bash
git checkout main
git pull origin main
```

### 2. worktreeを作成

#### 新規タスクの場合

`/using-git-worktrees` スキルを使用してworktreeを作成する。

```
/using-git-worktrees
```

これにより以下が自動化される:
- mainブランチを起点とした新しいブランチの作成
- `.worktrees/` ディレクトリへのworktree配置
- 環境変数ファイルのコピー
- 依存関係のインストール
- ベースラインテストの実行

**ブランチ命名規則**:
- `feature/機能名` - 新機能
- `fix/バグ名` - バグ修正
- `refactor/対象` - リファクタリング
- `docs/対象` - ドキュメント

#### 既存PRへの対応の場合

既存のブランチを使用してworktreeを作成する。

```bash
# リモートブランチを取得
git fetch origin

# 既存ブランチでworktreeを作成
git worktree add .worktrees/<ブランチ名> <ブランチ名>

# 例: PR #18のfeature/evaluator-agentブランチに対応する場合
git worktree add .worktrees/feature-evaluator-agent feature/evaluator-agent
```

作成後、環境変数のコピーと依存関係のインストールを手動で実行:

```bash
cd .worktrees/<ブランチ名>

# 環境変数のコピー（メインリポジトリから）
cp ../../.env .env 2>/dev/null || true
cp ../../tools/.env tools/.env 2>/dev/null || true

# 依存関係のインストール
npm install
cd tools && uv sync
```

### 3. 環境変数の確認（追加設定が必要な場合）

タスクに必要な環境変数を確認し、不足があればユーザーに尋ねる。

**確認事項**:
- [ ] `.env.example` または `.env.local.example` の存在確認
- [ ] 必要なAPIキーや認証情報
- [ ] 外部サービスへの接続情報

**不足時の対応**:
- 必要な環境変数名と用途をユーザーに質問する
- 機密情報は絶対にコードにハードコードしない

### 4. 必要なプログラムの存在確認

mainブランチにタスク開始に必要なプログラムやモジュールが存在することを確認する。

**確認事項**:
- [ ] 依存するモジュールやコンポーネントが存在するか
- [ ] 必要なAPIエンドポイントが実装されているか
- [ ] 必要な型定義やインターフェースが存在するか
- [ ] テスト用のユーティリティが揃っているか

### 5. 不足時のPR確認

必要なプログラムがmainに存在しない場合:

1. GitHub PRを確認する
   ```bash
   gh pr list --state open
   ```

2. 対象のタスクに関連するPRがあるか検索する
   ```bash
   gh pr list --search "キーワード"
   ```

3. 関連PRが見つかった場合:
   - ユーザーに該当PRの確認を依頼する
   - PRの内容を報告し、マージ待ちかレビュー待ちかを伝える

4. 関連PRがない場合:
   - 不足しているプログラムの実装が先に必要であることを報告する
   - 依存関係を明確にしてユーザーに判断を仰ぐ

## タスク完了時

タスクが完了したら `/push` コマンドを使用してPRを作成する。

```
/push
```

**PRには以下を含める**:
- 変更内容のサマリー
- テスト計画
- 関連するissueやタスクへのリンク（あれば）

## チェックリスト

### タスク開始前

- [ ] mainブランチを最新にしたか
- [ ] worktreeを作成したか（`/using-git-worktrees`または手動）
- [ ] `gh pr checkout`や`git checkout <branch>`を使っていないか
- [ ] 必要な環境変数を確認したか
- [ ] 依存プログラムがmainに存在するか
- [ ] 不足があればPRを確認したか

### タスク完了時

- [ ] すべてのテストが通っているか
- [ ] コーディングスタイルに従っているか
- [ ] `/push` でPRを作成したか
