# Task Start Rules

## タスク開始前の必須確認

**リポジトリ内のファイルを変更する際は、必ず以下の手順を実行すること。**

### 適用範囲

以下のすべての作業が対象:
- 新機能の実装
- バグ修正
- 既存PRへのレビュー対応・修正
- リファクタリング
- ドキュメント修正
- 設定ファイルの変更

### 禁止事項

以下の操作は禁止:
- `gh pr checkout <PR番号>` でブランチに直接チェックアウト
- `git checkout <ブランチ名>` で作業ブランチに直接チェックアウト
- mainブランチで直接ファイルを編集

### 0. GitHub Issueの確認

#### A. Issueが指定された場合

ユーザーから `https://github.com/Ikedatomohiro/writing-task/issues` のURLやIssue番号が指定された場合、まずIssueの内容を確認する。

```bash
# Issue番号を指定して内容を取得
gh issue view <Issue番号> --repo Ikedatomohiro/writing-task

# 例: Issue #5 の内容を確認
gh issue view 5 --repo Ikedatomohiro/writing-task
```

#### B. Issueが指定されていない場合

ユーザーから「タスクを開始して」「フロントエンドのタスク」「AIエージェントのタスク」などと言われた場合、**まず既存の作業状態を確認し、その後ロードマップを確認する**。

##### B-1. 既存の作業状態を確認（優先）

新規タスクを始める前に、未完了の作業がないか確認する。

```bash
# 1. 既存のworktreeを確認
git worktree list

# 2. オープンなPRを確認
gh pr list --state open --author @me

# 3. 作業中のブランチを確認（リモートにあるがマージされていないもの）
git branch -r --no-merged origin/main | grep -v HEAD
```

**確認事項**:
- [ ] 既存のworktreeがあるか → あれば作業を継続するか確認
- [ ] 自分が作成したオープンなPRがあるか → あればレビュー対応が必要か確認
- [ ] マージされていないブランチがあるか → 作業途中のものがないか確認

**未完了の作業が見つかった場合**:
1. ユーザーに状況を報告する
2. 以下の選択肢を提示する:
   - 既存の作業を継続する
   - 既存の作業を破棄して新規タスクを始める
   - 既存の作業を一旦保留して新規タスクを始める
3. ユーザーの判断を待つ

##### B-2. ロードマップから次のタスクを確認

未完了の作業がない場合、ロードマップから次に着手すべきタスクを確認する。

**ロードマップIssue一覧**:

| 分野 | Issue# | タイトル |
|------|--------|----------|
| フロントエンド | #33 | 【ロードマップ】ブログUI設計・実装 |
| AIエージェント | #45 | 【ロードマップ】AIエージェント開発 |

```bash
# フロントエンドのロードマップを確認
gh issue view 33 --repo Ikedatomohiro/writing-task

# AIエージェントのロードマップを確認
gh issue view 45 --repo Ikedatomohiro/writing-task
```

**ロードマップから読み取る情報**:
1. **現在のフェーズ**: ロードマップの「現在のフェーズ」セクションを確認
2. **次に着手すべきIssue**: 現在のフェーズ内で未完了のIssueを特定
3. **依存関係**: 着手するIssueに依存関係がないか確認

**ユーザーへの報告**:
- 現在のフェーズと状況を報告
- 次に着手すべきIssueを提案
- ユーザーの確認を得てから作業を開始

#### 確認事項（共通）

**確認事項**:
- [ ] Issueのタイトルと説明を読み、タスクの目的を理解する
- [ ] 受け入れ条件（Acceptance Criteria）があれば確認する
- [ ] 関連するIssueやPRへのリンクがあれば確認する
- [ ] ラベルや優先度を確認する

**Issueの内容に基づいて**:
- タスクの範囲を明確にする
- 不明点があればユーザーに質問する
- ブランチ名にIssue番号を含める（例: `feature/11-design-system`）

### 1. mainブランチを最新にする

worktree作成前に、必ずmainブランチを最新の状態にする。

```bash
git checkout main
git pull origin main
```

### 2. worktreeを作成

#### 新規タスクの場合

`/using-git-worktrees` スキルを使用してworktreeを作成する。

```
/using-git-worktrees
```

これにより以下が自動化される:
- mainブランチを起点とした新しいブランチの作成
- `.worktrees/` ディレクトリへのworktree配置
- 環境変数ファイルのコピー
- 依存関係のインストール
- ベースラインテストの実行

**ブランチ命名規則**:
- `feature/機能名` - 新機能
- `fix/バグ名` - バグ修正
- `refactor/対象` - リファクタリング
- `docs/対象` - ドキュメント

#### 既存PRへの対応の場合

既存のブランチを使用してworktreeを作成する。

**注意**: worktreeディレクトリ名には`/`を使用できないため、ブランチ名の`/`を`-`に置換する。

```bash
# リモートブランチを取得
git fetch origin

# 既存ブランチでworktreeを作成
# ディレクトリ名: ブランチ名の `/` を `-` に置換
git worktree add .worktrees/<ディレクトリ名> <ブランチ名>

# 例: PR #18のfeature/evaluator-agentブランチに対応する場合
# feature/evaluator-agent → feature-evaluator-agent
git worktree add .worktrees/feature-evaluator-agent feature/evaluator-agent
```

作成後、環境変数のコピーと依存関係のインストールを手動で実行:

```bash
cd .worktrees/<ディレクトリ名>

# 環境変数のコピー（メインリポジトリから）
cp ../../.env .env 2>/dev/null || true
cp ../../tools/.env tools/.env 2>/dev/null || true

# 依存関係のインストール
npm install
(cd tools && uv sync)  # サブシェルで実行
```

### 3. 環境変数の確認（追加設定が必要な場合）

タスクに必要な環境変数を確認し、不足があればユーザーに尋ねる。

**確認事項**:
- [ ] `.env.example` または `.env.local.example` の存在確認
- [ ] 必要なAPIキーや認証情報
- [ ] 外部サービスへの接続情報

**不足時の対応**:
- 必要な環境変数名と用途をユーザーに質問する
- 機密情報は絶対にコードにハードコードしない

### 4. 必要なプログラムの存在確認

mainブランチにタスク開始に必要なプログラムやモジュールが存在することを確認する。

**確認事項**:
- [ ] 依存するモジュールやコンポーネントが存在するか
- [ ] 必要なAPIエンドポイントが実装されているか
- [ ] 必要な型定義やインターフェースが存在するか
- [ ] テスト用のユーティリティが揃っているか

### 5. 不足時のPR確認

必要なプログラムがmainに存在しない場合:

1. GitHub PRを確認する
   ```bash
   gh pr list --state open
   ```

2. 対象のタスクに関連するPRがあるか検索する
   ```bash
   gh pr list --search "キーワード"
   ```

3. 関連PRが見つかった場合:
   - ユーザーに該当PRの確認を依頼する
   - PRの内容を報告し、マージ待ちかレビュー待ちかを伝える

4. 関連PRがない場合:
   - 不足しているプログラムの実装が先に必要であることを報告する
   - 依存関係を明確にしてユーザーに判断を仰ぐ

## 実装時のルール: TDD（テスト駆動開発）

**コードを実装する際は、必ずTDDで進めること。**

詳細なガイドラインは `.claude/skills/test-driven-development/SKILL.md` を参照。

### TDDの基本サイクル

1. **Red（失敗するテストを書く）**
   - 実装したい機能のテストを先に書く
   - テストを実行し、**失敗することを確認する**（必須）

2. **Green（テストを通す最小限の実装）**
   - テストが通る最小限のコードを書く
   - 過剰な実装をしない

3. **Refactor（リファクタリング）**
   - テストが通ったままコードを改善する
   - 重複を排除し、可読性を向上させる

### 鉄の掟

```
失敗するテストなしにプロダクションコードを書くな
```

テストより先にコードを書いた場合は、そのコードを削除してTDDでやり直すこと。

### 実装手順

```
1. テストファイルを作成
2. 失敗するテストを書く
3. テストを実行して失敗を確認（Red）← 必須、スキップ禁止
4. テストが通る最小限の実装を書く
5. テストを実行して成功を確認（Green）
6. 必要に応じてリファクタリング
7. 次の機能へ（1に戻る）
```

### テストを先に書く理由

- 実装漏れを防ぐ
- 仕様を明確にしてから実装できる
- CIでのカバレッジ不足を防ぐ
- リグレッションを防ぐ
- テストが実際に何かをテストしていることを証明する

### 例外（ユーザーの許可が必要）

以下の場合はTDDを省略可能:
- 設定ファイルのみの変更
- ドキュメントのみの変更
- テスト自体の修正
- 使い捨てプロトタイプ

## タスク完了時

タスクが完了したら、**PRレビュー観点でセルフチェック**を行ってから `/push` コマンドを使用してPRを作成する。

### PRレビュー観点でのセルフチェック（必須）

PR作成前に以下の観点で自己レビューを行うこと。これにより、レビュー時の指摘を事前に防ぐ。

#### セキュリティ

- [ ] シークレット（APIキー、パスワード等）がハードコードされていないか
- [ ] ユーザー入力に対するバリデーションが適切か
- [ ] SQLインジェクション/XSS/コマンドインジェクション対策がされているか
- [ ] エラーメッセージに機密情報（スタックトレース等）が含まれていないか

#### コード品質

- [ ] 関数は50行以下か（超える場合は分割を検討）
- [ ] ファイルは400行以下か（超える場合は分割を検討）
- [ ] ネストは4レベル以下か
- [ ] 命名は明確で一貫性があるか
- [ ] 重複コードがないか
- [ ] デバッグコード（console.log、print等）が残っていないか
- [ ] 不要なコメントアウトされたコードが残っていないか

#### 構造

- [ ] 新規ファイルは適切なディレクトリに配置されているか
- [ ] 依存関係の方向は適切か（上位→下位のみ、循環参照なし）
- [ ] 同階層のモジュールと命名規則・抽象度が統一されているか

#### spec.md整合性（該当する場合）

- [ ] spec.mdのすべての要件が実装されているか
- [ ] 仕様と異なる挙動がないか

詳細は `/pr-review` スキル（`.claude/skills/pr-review/SKILL.md`）を参照。

### PR作成

```
/push
```

**PRには以下を含める**:
- 変更内容のサマリー
- テスト計画
- **関連Issueのクローズキーワード（必須）**

### 関連Issueの自動クローズ（必須）

**PRの本文に必ず `Closes #XX` を含めること。** これにより、PRがマージされた時点でIssueが自動的にクローズされる。

```markdown
## Summary
- 機能Xを実装

## Test plan
- [ ] ユニットテストを実行

Closes #17
```

**使用可能なキーワード**:
- `Closes #XX` （推奨）
- `Fixes #XX`
- `Resolves #XX`

**複数のIssueをクローズする場合**:
```markdown
Closes #17, Closes #18
```

**注意事項**:
- Issueが別リポジトリ（writing-task）にある場合は `Closes Ikedatomohiro/writing-task#XX` と記載
- 関連Issueがない場合のみ省略可能（ただし、タスク開始時にIssueを確認しているはずなので、通常は必ず存在する）

### 振り返りと改善点の出力（必須）

**PR作成後、タスク対応中につまづいた点や改善点をコメントとして出力すること。**

これにより、プロジェクトのルールや開発環境の継続的な改善が可能になる。

#### 出力すべき内容

1. **つまづいた点**
   - 環境構築で問題があった箇所
   - ドキュメントが不足していた箇所
   - 既存コードの理解に時間がかかった箇所

2. **エラー・問題**
   - スクリプト実行時のエラーとその原因
   - テスト実行時の予期しない失敗
   - 依存関係やバージョンの問題

3. **改善提案**
   - ルールファイル（`.claude/rules/`）への追記提案
   - ドキュメントの改善案
   - 開発ワークフローの効率化案
   - ツールや設定の改善案

#### 出力フォーマット

```markdown
## 振り返り・改善点

### つまづいた点
- [具体的な内容]

### 発生したエラー
- **エラー内容**: [エラーメッセージ]
- **原因**: [原因の説明]
- **解決方法**: [どう解決したか]

### 改善提案
- [ ] [具体的な改善案とその理由]
```

#### 対応方法

- 軽微な改善（ルールファイルの追記等）は、ユーザーの許可を得てその場で対応する
- 大きな改善（アーキテクチャ変更等）は、別Issueとして起票を提案する
- 改善点がない場合は「特になし」と明記する

## チェックリスト

### タスク開始前

- [ ] 既存のworktree・PR・ブランチの状態を確認したか（未完了の作業がないか）
- [ ] GitHub Issueを確認したか（指定された場合は該当Issue、未指定の場合はロードマップ#33/#45）
- [ ] mainブランチを最新にしたか
- [ ] worktreeを作成したか（`/using-git-worktrees`または手動）
- [ ] `gh pr checkout`や`git checkout <branch>`を使っていないか
- [ ] 必要な環境変数を確認したか
- [ ] 依存プログラムがmainに存在するか
- [ ] 不足があればPRを確認したか

### 実装中

- [ ] テストを先に書いたか（TDD）
- [ ] テストが失敗することを確認したか（Red）
- [ ] テストが通る最小限の実装をしたか（Green）

### タスク完了時

- [ ] すべてのテストが通っているか
- [ ] 新規コードにテストが書かれているか
- [ ] コーディングスタイルに従っているか
- [ ] **PRレビュー観点でセルフチェックしたか**（セキュリティ、コード品質、構造、spec.md整合性）
- [ ] **PRの本文に `Closes #XX` を含めたか**（関連Issueの自動クローズ用）
- [ ] `/push` でPRを作成したか
- [ ] **振り返り・改善点を出力したか**（つまづいた点、エラー、改善提案）
